<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQC Rules</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: auto; }
        form { display: flex; flex-direction: column; gap: 10px; }
        label { font-weight: bold; margin-top: 10px; }
        input, select, textarea { width: 100%; padding: 8px; font-size: 14px; }
        button { padding: 10px; background-color: blue; color: white; border: none; cursor: pointer; margin-top: 15px; }
        button:hover { background-color: darkblue; }
        .table-container { height: 770px; width: 100%; overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; table-layout: auto; white-space: nowrap; }
        th, td { border: 1px solid black; padding: 10px; text-align: left; min-width: 150px; }
        th { background-color: #f2f2f2; text-align: center; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
    <script>
        let currentRows = [];
        const fieldOrder = JSON.parse('{{ fields.keys()|list|tojson }}');

        async function uploadCSV(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const response = await fetch('/upload_csv', { method: 'POST', body: formData });
            currentRows = await response.json();
            displayRows();
        }

        function validateRuleAbortInd(row, errors, errorPrefix) {
            const ruleValidMethCd = row["RULE_VALID_METH_CD"];
            const ruleAbortInd = row["RULE_ABORT_IND"];
            if ((ruleValidMethCd === "CNT_CHK" || ruleValidMethCd === "SUM_CHK") && ruleAbortInd === "Y") {
                errors.push(errorPrefix + "RULE_ABORT_IND must be 'N' for CNT_CHK or SUM_CHK.");
            }
            if (!["CNT_CHK", "SUM_CHK"].includes(ruleValidMethCd) && ruleAbortInd === "N") {
                errors.push(errorPrefix + "RULE_ABORT_IND must be 'Y' for RULE_VALID_METH_CD values other than CNT_CHK or SUM_CHK.");
            }
        }

        function validateRuleTrgtAttrNm(row, errors, errorPrefix) {
            const meth = row["RULE_VALID_METH_CD"];
            const attr = row["RULE_TRGT_ATTR_NM"];
            if ((meth === "SUM_CHK" || meth === "DIFF_SUM_CHK") && (!attr || attr === "NA")) {
                errors.push(errorPrefix + "RULE_TRGT_ATTR_NM cannot be blank or 'NA' when RULE_VALID_METH_CD is SUM_CHK or DIFF_SUM_CHK.");
            }
        }

        function validateRuleSequenceNumber(row, errors, errorPrefix, allowedDuplicateRowCount) {
            const sequenceNumberDuplicates = currentRows.filter(r =>
                r["RULE_TRGT_OBJ_ID_TXT"] === row["RULE_TRGT_OBJ_ID_TXT"] &&
                ((r["RULE_VALID_CTGY_NM"] === "POST" && row["RULE_VALID_CTGY_NM"] === "POST") ||
                (r["RULE_VALID_CTGY_NM"] === "PRE" && row["RULE_VALID_CTGY_NM"] === "PRE")) &&
                r["RULE_SEQ_NR"] === row["RULE_SEQ_NR"]
            );

            if (sequenceNumberDuplicates.length > allowedDuplicateRowCount) {
                errors.push(errorPrefix + "Duplicate RULE_TRGT_OBJ_ID_TXT with 'POST' or 'PRE' and same RULE_SEQ_NR.");
            }
        }

        function validateRuleNameIsUnique(row, errors, errorPrefix, allowedDuplicateRowCount) {
            const ruleNameDuplicates = currentRows.filter(r => r["RULE_NM"] === row["RULE_NM"]);
            if (ruleNameDuplicates.length > allowedDuplicateRowCount) {
                errors.push(errorPrefix + "RULE_NM already exists.");
            }
        }

        function validateRuleNameMatchesStandards(row, errors, errorPrefix) {
            const ruleNameRegularExpressions = [
                "^[A-Z0–9_]+OP_HOP3_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+OP_HOP2_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+OP_HOP1_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+DL2_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+FND_DL3_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+STG_DL3_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+INFO_DL3_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+OP_HOP3_HOP2_DIFF_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+OP_HOP2_HOP1_DIFF_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+OP_HOP1_DL2_DIFF_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+DL2_FND_DIFF_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+STG_INFO_DIFF_(CNT|SUM)_CHK$",
                "^[A-Z0–9_]+INFO_DL3_DUP_CHK$",
                "^[A-Z0–9_]+INFO_DL3_OVERLAP_CHK$"
            ];
            if (!ruleNameRegularExpressions.some(pattern => new RegExp(pattern).test(row["RULE_NM"]))) {
                errors.push(errorPrefix + "RULE_NM does not match any of the specified patterns");
            }
        }

        function validateSingleRow(row, isNewRow) {
            let errors = [];
            const allowedDuplicateRowCount = isNewRow ? 0 : 1;
            validateRuleAbortInd(row, errors, "-");
            validateRuleSequenceNumber(row, errors, "-", allowedDuplicateRowCount);
            validateRuleNameMatchesStandards(row, errors, "-");
            validateRuleNameIsUnique(row, errors, "-", allowedDuplicateRowCount);
            validateRuleTrgtAttrNm(row, errors, "-");
            if (errors.length > 0) {
                alert("Validation Errors:\n" + errors.join("\n"));
                return false;
            } else {
                return true;
            }
        }

        async function addRow(event) {
            event.preventDefault();
            let newRow = {};
            fieldOrder.forEach(field => {
                let inputElement = document.querySelector(`[name="${field}"]`);
                newRow[field] = inputElement ? inputElement.value : "";
            });
            if (!validateSingleRow(newRow, true)) {
                return;
            }
            const response = await fetch('/add_row', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newRow)
            });
            currentRows = await response.json();
            displayRows();
        }

        function editRow(index) {
            const row = document.querySelector(`#row-${index}`);
            const cells = row.querySelectorAll("td");
            for (let i = 0; i < cells.length - 1; i++) {
                let value = cells[i].innerText;
                cells[i].innerHTML = `<input type="text" value="${value}" />`;
            }
            document.getElementById(`edit-btn-${index}`).style.display = "none";
            document.getElementById(`save-btn-${index}`).style.display = "inline-block";
        }

        async function saveRow(index) {
            const row = document.querySelector(`#row-${index}`);
            const cells = row.querySelectorAll("td");
            let updatedRow = {};
            for (let i = 0; i < cells.length - 1; i++) {
                let inputValue = cells[i].querySelector("input").value;
                updatedRow[fieldOrder[i]] = inputValue;
            }
            if (!validateSingleRow(updatedRow, false)) {
                return;
            }
            currentRows[index] = updatedRow;
            await fetch('/update_row', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index, updatedRow })
            });
            for (let i = 0; i < cells.length - 1; i++) {
                cells[i].innerText = updatedRow[fieldOrder[i]];
            }
            document.getElementById(`edit-btn-${index}`).style.display = "inline-block";
            document.getElementById(`save-btn-${index}`).style.display = "none";
        }

        async function deleteRow(index) {
            const response = await fetch('/delete_row', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index })
            });
            currentRows = await response.json();
            displayRows();
        }

        function displayRows() {
            if (currentRows.length === 0) {
                document.getElementById("preview").innerHTML = "<p>No data available.</p>";
                return;
            }
            let tableHTML = `<div class="table-container"><table><tr>`;
            fieldOrder.forEach(key => tableHTML += `<th>${key}</th>`);
            tableHTML += `<th>Actions</th></tr>`;
            currentRows.forEach((row, index) => {
                tableHTML += `<tr id="row-${index}">`;
                fieldOrder.forEach(key => {
                    tableHTML += `<td>${row[key] || ''}</td>`;
                });
                tableHTML += `
                    <td>
                        <button id="edit-btn-${index}" onclick="editRow(${index})" style="background-color: blue; color: white;">Edit</button>
                        <button id="save-btn-${index}" onclick="saveRow(${index})" style="display:none; background-color: blue; color: white;">Save</button>
                        <button id="delete-btn-${index}" onclick="deleteRow(${index})" style="background-color:red; color:white;">Delete</button>
                    </td>
                </tr>`;
            });
            tableHTML += `</table></div>`;
            document.getElementById("preview").innerHTML = tableHTML;
        }

        function updateRuleAbortInd() {
            const ruleValidMethCd = document.querySelector('[name="RULE_VALID_METH_CD"]').value;
            const ruleAbortInd = document.querySelector('[name="RULE_ABORT_IND"]');
            const abortIndValues = ["DIFF_CNT_CHK", "DIFF_SUM_CHK", "DUP_CHK", "OVERLAP_CHK"];
            ruleAbortInd.value = abortIndValues.includes(ruleValidMethCd) ? "Y" : "N";
        }
        function updateRuleTrgtAttrNm() {
            const ruleValidMethCd = document.querySelector('[name="RULE_VALID_METH_CD"]').value;
            const ruleTrgtAttrNm = document.querySelector('[name="RULE_TRGT_ATTR_NM"]');
            if (ruleValidMethCd === "SUM_CHK" || ruleValidMethCd === "DIFF_SUM_CHK") {
                ruleTrgtAttrNm.value = "";
            } else {
                ruleTrgtAttrNm.value = "NA";
            }
        }
        function updateRuleName() {
            const ruleTargetTableName = document.querySelector('[name="RULE_TRGT_OBJ_ID_TXT"]').value;
            const ruleValidMethCd = document.querySelector('[name="RULE_VALID_METH_CD"]').value;
            const ruleTargetDBName = document.querySelector('[name="RULE_TRGT_DB_NM"]').value;
            const ruleTargetDataLayerName = document.querySelector('[name="RULE_TRGT_DATA_LAYER_NM"]').value;
            const ruleName = document.querySelector('[name="RULE_NM"]');
            let ruleTargetComponent;
            if (ruleTargetDBName === "CFOPAYMENTSDB") {
                if (["CNT_CHK", "SUM_CHK"].includes(ruleValidMethCd)) {
                    if (ruleTargetDataLayerName === "OnPrem_HOP3") {
                        ruleTargetComponent = "OP_HOP3";
                    } else if (ruleTargetDataLayerName === "OnPrem_HOP2") {
                        ruleTargetComponent = "OP_HOP2";
                    } else if (ruleTargetDataLayerName === "OnPrem_HOP1") {
                        ruleTargetComponent = "OP_HOP1";
                    } else if (ruleTargetDataLayerName === "DL2") {
                        ruleTargetComponent = "DL2";
                    } else if (ruleTargetDataLayerName === "DL3") {
                        ruleTargetComponent = "FND_DL3";
                    } else {
                        ruleTargetComponent = "UNKNOWN";
                    }
                } else if (["DIFF_CNT_CHK", "DIFF_SUM_CHK"].includes(ruleValidMethCd)) {
                    if (ruleTargetDataLayerName === "OnPrem") {
                        ruleTargetComponent = "OP_(HOP3_HOP2|HOP2_HOP1)";
                    } else if (ruleTargetDataLayerName === "DL2") {
                        ruleTargetComponent = "OP_HOP1_DL2";
                    } else if (ruleTargetDataLayerName === "DL3") {
                        ruleTargetComponent = "DL2_FND";
                    } else {
                        ruleTargetComponent = "UNKNOWN";
                    }
                }
            } else if (ruleTargetDBName === "CFOINFODMDB") {
                if (["CNT_CHK", "SUM_CHK"].includes(ruleValidMethCd)) {
                    ruleTargetComponent = "(STG|INFO)_DL3";
                } else if (["DIFF_CNT_CHK", "DIFF_SUM_CHK"].includes(ruleValidMethCd)) {
                    ruleTargetComponent = "STG_INFO";
                } else if (["DUP_CHK", "OVERLAP_CHK"].includes(ruleValidMethCd)) {
                    ruleTargetComponent = "INFO_DL3";
                } else {
                    ruleTargetComponent = "UNKNOWN";
                }
            }
            ruleName.value = ruleTargetTableName + "_" + ruleTargetComponent + "_" + ruleValidMethCd;
        }
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('[name="RULE_VALID_METH_CD"]').addEventListener('change', () => {
                updateRuleAbortInd();
                updateRuleName();
                updateRuleTrgtAttrNm();
            });
            document.querySelector('[name="RULE_TRGT_OBJ_ID_TXT"]').addEventListener('mouseout', updateRuleName);
            document.querySelector('[name="RULE_TRGT_DB_NM"]').addEventListener('change', updateRuleName);
            document.querySelector('[name="RULE_TRGT_DATA_LAYER_NM"]').addEventListener('change', updateRuleName);
        });
    </script>
</head>
<body>
    <div class="container">
        <h2>Upload Existing DQC Rules</h2>
        <form onsubmit="uploadCSV(event)" enctype="multipart/form-data">
            <input type="file" name="file" required>
            <button type="submit">Upload and Preview</button>
        </form>
        <h2>Enter new DQC Rules</h2>
        <form onsubmit="addRow(event)">
            {% for field, value in fields.items() %}
                {% if field in ["DATA_QC_ID", "RULE_FREQ_CD", "RULE_SRC_ATTR_NM", "RULE_MIN_THRESH_VALUE_TXT", "RULE_MAX_THRESH_VALUE_TXT", "RULE_CDE_IND", "RULE_EXP_DT", "RULE_EFF_DT", "UPDT_PRTY_ID", "UPDT_TS", "RULE_RMRK_TXT", "ETL_CREA_NR", "ETL_CREA_TS", "ETL_UPDT_TS", "RULE_ACPT_VARY_PCT", "ETL_UPDT_NR", "ASSET_ID", "ASSET_NM", "CREA_TS"] %}
                    <input type="hidden" name="{{ field }}" id="{{ field }}" value="{{ value }}" disabled>
                {% elif value.__class__.__name__ == 'list' %}
                    <label for="{{ field }}">{{ field }}</label>
                    {% if field == "RULE_ABORT_IND" %}
                        <select name="{{ field }}" id="{{ field }}" required disabled>
                            {% for option in value %}
                                <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <select name="{{ field }}" id="{{ field }}" required>
                            {% for option in value %}
                                <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    {% endif %}
                {% else %}
                    {% if field == "RULE_NM" %}
                        <label for="{{ field }}">{{ field }}: Refer to <a href="https://wiki.usaa.com/display/EMM/Data+Control+Framework#Architecture-DQCRuleNamingStandards" target="_blank">DQC Rule Naming Standards</a> for guidance</label>
                        <input type="text" name="{{ field }}" id="{{ field }}" value="{{ value }}" required>
                        <div><b>Note:</b> this app will attempt to auto-populate the rule name based on choices below. However, if the auto-populated rule name contains something like (STG|INFO), that means the user must pick either STG or INFO manually. Thus, the final rule name could contain either _STG_DL3_ or _INFO_DL3_.</div>
                    {% elif field == "RULE_TRGT_ATTR_NM" %}
                        <label for="{{ field }}">{{ field }}</label>
                        <input type="text" name="{{ field }}" id="{{ field }}" value="{{ value }}" required>
                    {% else %}
                        <label for="{{ field }}">{{ field }}</label>
                        <input type="text" name="{{ field }}" id="{{ field }}" value="{{ value }}" required>
                    {% endif %}
                {% endif %}
            {% endfor %}
            <button type="submit">Add Rule</button>
        </form>
    </div>
    <h2>Preview Rules</h2>
    <button onclick="validateUploadedFile()">Validate Uploaded File</button>
    <a href="/generate_csv">
        <button>Generate CSV</button>
    </a>
    <div id="preview"></div>
</body>
</html>